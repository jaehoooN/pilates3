name: ğŸ‹ï¸ í•„ë¼í…ŒìŠ¤ ìë™ ì˜ˆì•½

on:
  schedule:
    # í•œêµ­ì‹œê°„ ë§¤ì¼ 00:00 (UTC 15:00)
    # ì •ê°ì— ì‹¤í–‰í•˜ë˜, ì£¼ë§ì€ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ìë™ ìŠ¤í‚µ
    - cron: '0 15 * * *'  # ì •í™•íˆ ìì •ì— ì‹¤í–‰í•˜ë„ë¡ ìˆ˜ì •
  
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'í…ŒìŠ¤íŠ¸ ëª¨ë“œ (ì‹¤ì œ ì˜ˆì•½í•˜ì§€ ì•ŠìŒ)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      force_weekend:
        description: 'ì£¼ë§ì—ë„ ê°•ì œ ì‹¤í–‰ (í…ŒìŠ¤íŠ¸ìš©)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  check-weekday:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      target_date: ${{ steps.check.outputs.target_date }}
      day_name: ${{ steps.check.outputs.day_name }}
    steps:
    - name: ğŸ“… ì£¼ë§ ì²´í¬ (KST ê¸°ì¤€) - ìˆ˜ì •ë¨
      id: check
      run: |
        # í˜„ì¬ UTC ì‹œê°„ì„ KSTë¡œ ë³€í™˜í•˜ì—¬ 7ì¼ í›„ ê³„ì‚°
        echo "í˜„ì¬ UTC: $(date -u)"
        
        # KST ê¸°ì¤€ í˜„ì¬ ì‹œê°„ (UTC + 9ì‹œê°„)
        current_kst=$(TZ='Asia/Seoul' date)
        echo "í˜„ì¬ KST: $current_kst"
        
        # KST ê¸°ì¤€ í˜„ì¬ ìš”ì¼ í™•ì¸
        current_day=$(TZ='Asia/Seoul' date '+%u')
        current_day_name=$(TZ='Asia/Seoul' date '+%A')
        echo "í˜„ì¬ ìš”ì¼: $current_day_name (ìˆ«ì: $current_day)"
        
        # KST ê¸°ì¤€ 7ì¼ í›„ ë‚ ì§œ ê³„ì‚°
        target_date=$(TZ='Asia/Seoul' date -d '+7 days' '+%Y-%m-%d')
        target_day=$(TZ='Asia/Seoul' date -d '+7 days' '+%u') # 1=ì›”ìš”ì¼, 7=ì¼ìš”ì¼
        day_name_en=$(TZ='Asia/Seoul' date -d '+7 days' '+%A')
        
        # í•œêµ­ì–´ ìš”ì¼ ë³€í™˜
        case $day_name_en in
          "Monday") day_name="ì›”ìš”ì¼" ;;
          "Tuesday") day_name="í™”ìš”ì¼" ;;
          "Wednesday") day_name="ìˆ˜ìš”ì¼" ;;
          "Thursday") day_name="ëª©ìš”ì¼" ;;
          "Friday") day_name="ê¸ˆìš”ì¼" ;;
          "Saturday") day_name="í† ìš”ì¼" ;;
          "Sunday") day_name="ì¼ìš”ì¼" ;;
          *) day_name=$day_name_en ;;
        esac
        
        echo "ğŸ¯ ì˜ˆì•½ ëŒ€ìƒ ë‚ ì§œ: $target_date ($day_name)"
        echo "ğŸ“Š ì˜ˆì•½ ëŒ€ìƒ ìš”ì¼ ë²ˆí˜¸: $target_day (1=ì›”, 2=í™”, 3=ìˆ˜, 4=ëª©, 5=ê¸ˆ, 6=í† , 7=ì¼)"
        
        # ì£¼ë§ ì²´í¬ ìˆ˜ì •: 6=í† ìš”ì¼, 7=ì¼ìš”ì¼ë§Œ ì£¼ë§ë¡œ íŒì •
        if [ "$target_day" -eq 6 ] || [ "$target_day" -eq 7 ]; then
          if [ "${{ github.event.inputs.force_weekend }}" = "true" ]; then
            echo "âš ï¸ ì£¼ë§($day_name)ì´ì§€ë§Œ ê°•ì œ ì‹¤í–‰ ëª¨ë“œ"
            should_run="true"
          else
            echo "ğŸš« ì£¼ë§($day_name)ì´ë¯€ë¡œ ì˜ˆì•½ ê±´ë„ˆë›°ê¸°"
            should_run="false"
          fi
        else
          echo "âœ… í‰ì¼($day_name)ì´ë¯€ë¡œ ì˜ˆì•½ ì§„í–‰"
          should_run="true"
        fi
        
        # ë””ë²„ê¹…ì„ ìœ„í•œ ì¶”ê°€ ì •ë³´
        echo "ğŸ” ë””ë²„ê¹… ì •ë³´:"
        echo "   - í˜„ì¬ KST ìš”ì¼: $current_day ($current_day_name)"
        echo "   - ì˜ˆì•½ ëŒ€ìƒ ìš”ì¼: $target_day ($day_name)"
        echo "   - ì‹¤í–‰ ì—¬ë¶€: $should_run"
        
        echo "should_run=$should_run" >> $GITHUB_OUTPUT
        echo "target_date=$target_date" >> $GITHUB_OUTPUT
        echo "day_name=$day_name" >> $GITHUB_OUTPUT

  booking:
    needs: check-weekday
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: needs.check-weekday.outputs.should_run == 'true'
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: ğŸ“¦ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: ğŸ”§ ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm install
    
    - name: ğŸ¯ ì˜ˆì•½ ì‹¤í–‰
      env:
        PILATES_USERNAME: ${{ secrets.PILATES_USERNAME }}
        PILATES_PASSWORD: ${{ secrets.PILATES_PASSWORD }}
        TEST_MODE: ${{ github.event.inputs.test_mode }}
        NODE_ENV: production
        HEADLESS: true
      run: |
        echo "ğŸ¯ ì˜ˆì•½ ëŒ€ìƒ: ${{ needs.check-weekday.outputs.target_date }} (${{ needs.check-weekday.outputs.day_name }})"
        echo "ğŸ• ì‹¤í–‰ ì‹œê°„: $(TZ='Asia/Seoul' date)"
        node booking-script.js
      continue-on-error: true
    
    - name: ğŸ“Š ê²°ê³¼ í™•ì¸
      id: check-result
      if: always()
      run: |
        echo "ğŸ“Š ì˜ˆì•½ ê²°ê³¼ í™•ì¸ ì¤‘..."
        if [ -f "booking-result.json" ]; then
          echo "âœ… ê²°ê³¼ íŒŒì¼ ë°œê²¬"
          echo "ğŸ“„ ê²°ê³¼ ë‚´ìš©:"
          cat booking-result.json
          
          # ê²°ê³¼ì—ì„œ ìƒíƒœ ì¶”ì¶œ
          status=$(jq -r '.status // "UNKNOWN"' booking-result.json)
          echo "ğŸ“ˆ ì˜ˆì•½ ìƒíƒœ: $status"
          
          case $status in
            "SUCCESS"|"WAITING"|"ALREADY_BOOKED"|"WEEKEND_SKIP")
              echo "âœ… ì •ìƒ ì™„ë£Œ: $status"
              ;;
            "TEST")
              echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ëª¨ë“œ ì™„ë£Œ"
              ;;
            *)
              echo "âš ï¸ ì˜ˆìƒì¹˜ ëª»í•œ ìƒíƒœ: $status"
              ;;
          esac
        else
          echo "âŒ ê²°ê³¼ íŒŒì¼ ì—†ìŒ"
        fi
    
    - name: ğŸ“¸ ê²°ê³¼ ì €ì¥
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: booking-result-${{ github.run_number }}
        path: |
          screenshots/
          logs/
          *.json
        if-no-files-found: warn
        retention-days: 30

  weekend-skip:
    needs: check-weekday
    runs-on: ubuntu-latest
    if: needs.check-weekday.outputs.should_run == 'false'
    
    steps:
    - name: ğŸš« ì£¼ë§ ìŠ¤í‚µ ì•Œë¦¼
      run: |
        echo "ğŸš« ì£¼ë§ ì˜ˆì•½ ìŠ¤í‚µ"
        echo "ğŸ“… ì˜ˆì•½ ëŒ€ìƒ ë‚ ì§œ: ${{ needs.check-weekday.outputs.target_date }}"
        echo "ğŸ“† ìš”ì¼: ${{ needs.check-weekday.outputs.day_name }}"
        echo "â­ï¸ ë‹¤ìŒ í‰ì¼ì— ìë™ ì‹¤í–‰ë©ë‹ˆë‹¤."
        echo "ğŸ• í˜„ì¬ KST: $(TZ='Asia/Seoul' date)"
        echo "ğŸ” ì£¼ë§ íŒì •: í† ìš”ì¼(6) ë˜ëŠ” ì¼ìš”ì¼(7)ë§Œ ì£¼ë§ë¡œ ì²˜ë¦¬"
